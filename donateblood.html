<!DOCTYPE html>
<html>
<head>
  <title>BloodBridge - Donate Blood</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Poppins', Arial, sans-serif; }
    #map { height: 100vh; width: 100%; }
    .header {
      position: absolute; top: 0; left: 0; right: 0;
      background: rgba(0, 0, 0, 0.9); color: #ff4d4d;
      padding: 15px 20px; z-index: 1000;
      display: flex; justify-content: space-between; align-items: center;
    }
    .header h1 { font-size: 22px; }
    .back-btn {
      background: #ff4d4d; color: white; border: none;
      padding: 10px 20px; border-radius: 8px; cursor: pointer;
      font-size: 14px; text-decoration: none;
    }
    .back-btn:hover { background: #cc0000; }
    .sidebar {
      position: absolute; top: 70px; left: 0; width: 380px;
      height: calc(100vh - 70px); background: rgba(0, 0, 0, 0.92);
      z-index: 1000; display: flex; flex-direction: column;
      transition: transform 0.3s ease;
    }
    .sidebar.collapsed { transform: translateX(-100%); }
    .sidebar-toggle {
      position: absolute; top: 50%; right: -40px; transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.9); color: #ff4d4d; border: none;
      width: 40px; height: 80px; cursor: pointer; font-size: 20px;
      border-radius: 0 8px 8px 0;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .header h1 { font-size: 16px; }
      .back-btn { padding: 8px 12px; font-size: 12px; }
      .sidebar { width: 100%; }
      .sidebar-toggle { right: -35px; width: 35px; height: 60px; font-size: 16px; }
      .sidebar-header { padding: 15px; }
      .sidebar-header h3 { font-size: 16px; }
      .hospital-item { padding: 12px; }
      .hospital-item h4 { font-size: 13px; }
      .request-item { padding: 10px; }
      .request-item .blood-type { font-size: 16px; }
      .modal { padding: 20px; width: 95%; }
      .modal h2 { font-size: 18px; }
      .modal .blood-group-large { font-size: 36px; }
      .modal .detail-row { padding: 10px 0; font-size: 13px; }
      .loading { padding: 20px; width: 90%; }
    }
    .sidebar-header { padding: 20px; border-bottom: 1px solid #333; }
    .sidebar-header h3 { color: #ff4d4d; margin-bottom: 5px; }
    .sidebar-header p { color: #aaa; font-size: 13px; }
    .hospital-list { flex: 1; overflow-y: auto; padding: 10px; }
    .hospital-item {
      background: rgba(255, 77, 77, 0.1); border: 1px solid #ff4d4d33;
      border-radius: 10px; padding: 15px; margin-bottom: 10px;
      cursor: pointer; transition: all 0.2s ease;
    }
    .hospital-item:hover { background: rgba(255, 77, 77, 0.25); }
    .hospital-item h4 { color: white; font-size: 14px; margin-bottom: 5px; }
    .hospital-item p { color: #aaa; font-size: 12px; }
    .hospital-item .distance { color: #ff4d4d; font-size: 12px; margin-top: 5px; }
    .request-item {
      background: rgba(255, 200, 0, 0.15); border: 1px solid #ffaa0055;
      border-radius: 8px; padding: 12px; margin-top: 10px;
      cursor: pointer; transition: all 0.2s ease;
    }
    .request-item:hover { background: rgba(255, 200, 0, 0.25); }
    .request-item .blood-type { font-size: 18px; font-weight: bold; color: #ff4d4d; }
    .request-item .urgency-high { color: #ff4d4d; }
    .request-item .urgency-medium { color: #ffaa00; }
    .request-item .urgency-low { color: #00cc44; }
    .request-item p { color: #ccc; font-size: 12px; margin-top: 4px; }
    .loading {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9); color: white; padding: 30px 40px;
      border-radius: 12px; z-index: 2000; text-align: center;
    }
    .loading-spinner {
      border: 4px solid #333; border-top: 4px solid #ff4d4d;
      border-radius: 50%; width: 40px; height: 40px;
      animation: spin 1s linear infinite; margin: 0 auto 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .search-google-btn {
      margin: 15px; padding: 12px; background: #ff4d4d; color: white;
      border: none; border-radius: 8px; cursor: pointer; font-size: 14px;
    }
    .search-google-btn:hover { background: #cc0000; }
    .hospital-list::-webkit-scrollbar { width: 6px; }
    .hospital-list::-webkit-scrollbar-track { background: #222; }
    .hospital-list::-webkit-scrollbar-thumb { background: #ff4d4d; border-radius: 3px; }
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8); z-index: 3000;
      justify-content: center; align-items: center;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: #1a1a1a; border-radius: 16px; padding: 30px;
      width: 90%; max-width: 450px; max-height: 90vh; overflow-y: auto;
      border: 1px solid #ff4d4d33; box-shadow: 0 0 30px rgba(255,0,0,0.3);
    }
    .modal h2 { color: #ff4d4d; margin-bottom: 20px; font-size: 22px; }
    .modal .detail-row {
      display: flex; justify-content: space-between; padding: 12px 0;
      border-bottom: 1px solid #333;
    }
    .modal .detail-row .label { color: #888; }
    .modal .detail-row .value { color: white; font-weight: 500; text-align: right; max-width: 60%; }
    .modal .blood-group-large {
      font-size: 48px; color: #ff4d4d; text-align: center;
      margin: 20px 0; font-weight: bold;
    }
    .modal .contact-btn {
      width: 100%; padding: 14px; background: #00cc44; color: white;
      border: none; border-radius: 8px; font-size: 16px; font-weight: 600;
      cursor: pointer; margin-top: 20px; text-decoration: none; display: block; text-align: center;
    }
    .modal .contact-btn:hover { background: #00aa33; }
    .modal .close-btn {
      width: 100%; padding: 14px; background: #333; color: white;
      border: none; border-radius: 8px; font-size: 16px;
      cursor: pointer; margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ü©∏ BloodBridge - Donate Blood</h1>
    <a href="home.html" class="back-btn">‚Üê Back to Home</a>
  </div>

  <div id="loading" class="loading">
    <div class="loading-spinner"></div>
    <p>Getting your location...</p>
  </div>

  <div id="sidebar" class="sidebar">
    <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
    <div class="sidebar-header">
      <h3>üè• Blood Requests & Hospitals</h3>
      <p id="status-text">Loading...</p>
    </div>
    <div class="hospital-list" id="hospital-list"></div>
    <button class="search-google-btn" onclick="searchNearbyHospitals()">
      üîç Search on Google Maps
    </button>
  </div>

  <div id="map"></div>

  <div class="modal-overlay" id="modal-overlay">
    <div class="modal">
      <h2>ü©∏ Blood Request Details</h2>
      <div class="blood-group-large" id="modal-blood-group"></div>
      <div id="modal-details"></div>
      <a id="contact-btn" class="contact-btn" href="#">üìû Call Now</a>
      <button class="close-btn" onclick="closeModal()">Close</button>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map, userLat, userLng, hospitalMarkers = [], routeLine = null;
    let bloodRequests = [];
    let hospitalsData = [];

    function initMap() {
      map = L.map('map').setView([20.5937, 78.9629], 5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);

      // Listen for blood requests from Firebase (real-time)
      BloodRequests.getAll((requests) => {
        console.log('Firebase requests loaded:', requests.length);
        bloodRequests = requests;
        renderList();
      });

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            userLat = position.coords.latitude;
            userLng = position.coords.longitude;
            map.setView([userLat, userLng], 14);

            const userIcon = L.divIcon({
              html: '<div style="background: #4285F4; width: 18px; height: 18px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(66,133,244,0.8);"></div>',
              className: 'user-marker', iconSize: [18, 18]
            });

            L.marker([userLat, userLng], { icon: userIcon })
              .addTo(map).bindPopup('<strong>üìç You are here</strong>').openPopup();

            document.getElementById('loading').style.display = 'none';
            fetchNearbyHospitals(userLat, userLng);
          },
          (error) => {
            console.error('Geolocation error:', error);
            document.getElementById('loading').style.display = 'none';
            
            let errorMsg = 'Location unavailable';
            if (error.code === 1) {
              errorMsg = 'Location denied - enable in settings';
            }
            document.getElementById('status-text').textContent = errorMsg;
            
            // Show help message in sidebar
            const listEl = document.getElementById('hospital-list');
            listEl.innerHTML = `
              <div style="padding: 20px; text-align: center; color: #aaa;">
                <p style="margin-bottom: 15px;">üìç Location access needed to find nearby hospitals</p>
                <p style="font-size: 12px; margin-bottom: 10px;"><strong>On Mobile:</strong><br>Settings ‚Üí Browser ‚Üí Site Settings ‚Üí Location ‚Üí Allow</p>
                <p style="font-size: 12px; margin-bottom: 15px;"><strong>On iPhone:</strong><br>Settings ‚Üí Safari ‚Üí Location ‚Üí Allow</p>
                <button onclick="location.reload()" style="padding: 10px 20px; background: #ff4d4d; color: white; border: none; border-radius: 8px; cursor: pointer;">Try Again</button>
              </div>
            `;
            renderList();
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      } else {
        document.getElementById('loading').style.display = 'none';
        renderList();
      }
    }

    function fetchNearbyHospitals(lat, lng) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=hospital&limit=20&bounded=1&viewbox=${lng-0.1},${lat+0.1},${lng+0.1},${lat-0.1}`;

      fetch(url, { headers: { 'User-Agent': 'BloodBridge App' } })
        .then(response => response.json())
        .then(data => {
          if (data && data.length > 0) {
            hospitalsData = data.map(place => ({
              name: place.display_name.split(',')[0],
              lat: parseFloat(place.lat),
              lng: parseFloat(place.lon),
              distance: getDistance(lat, lng, parseFloat(place.lat), parseFloat(place.lon))
            })).sort((a, b) => a.distance - b.distance);
          }
          renderList();
        })
        .catch(() => renderList());
    }

    function renderList() {
      const listEl = document.getElementById('hospital-list');
      listEl.innerHTML = '';

      // Clear old markers
      hospitalMarkers.forEach(m => map.removeLayer(m));
      hospitalMarkers = [];

      const totalRequests = bloodRequests.length;
      document.getElementById('status-text').textContent = 
        (totalRequests > 0 ? `${totalRequests} blood request(s)` : 'No requests') + 
        (hospitalsData.length > 0 ? ` ‚Ä¢ ${hospitalsData.length} hospitals` : '');

      // Show ALL blood requests at the top
      if (bloodRequests.length > 0) {
        const requestsSection = document.createElement('div');
        requestsSection.className = 'hospital-item';
        requestsSection.style.background = 'rgba(255, 0, 0, 0.2)';
        requestsSection.style.borderColor = '#ff4d4d';
        
        let html = `<h4 style="color:#ff4d4d">üÜò Blood Requests (${bloodRequests.length})</h4>`;
        
        bloodRequests.forEach(req => {
          const urgencyClass = `urgency-${req.urgency}`;
          const urgencyText = req.urgency === 'high' ? 'üî¥ Urgent' : req.urgency === 'medium' ? 'üü° Medium' : 'üü¢ Low';
          html += `
            <div class="request-item" onclick="showRequestDetails('${req.id}')">
              <span class="blood-type">${req.bloodGroup}</span>
              <span class="${urgencyClass}" style="float:right">${urgencyText}</span>
              <p><strong>${req.hospitalName}</strong></p>
              <p>${req.unitsRequired} unit(s) ‚Ä¢ ${formatDate(req.requiredBy)}</p>
            </div>
          `;

          // Add marker for request
          if (req.hospitalLat && req.hospitalLng) {
            const marker = L.marker([req.hospitalLat, req.hospitalLng]).addTo(map)
              .bindPopup(`<strong>ü©∏ ${req.bloodGroup} needed</strong><br>${req.hospitalName}<br><span style="color:#ff4d4d">${urgencyText}</span>`);
            hospitalMarkers.push(marker);
          }
        });

        requestsSection.innerHTML = html;
        listEl.appendChild(requestsSection);
      } else {
        const noRequests = document.createElement('div');
        noRequests.className = 'hospital-item';
        noRequests.innerHTML = `<p style="color:#888; text-align:center;">No blood requests at the moment</p>`;
        listEl.appendChild(noRequests);
      }

      // Show hospitals
      if (hospitalsData.length > 0) {
        const hospitalsHeader = document.createElement('div');
        hospitalsHeader.innerHTML = `<h4 style="color:#ff4d4d; padding: 15px 0 5px;">üè• Nearby Hospitals</h4>`;
        listEl.appendChild(hospitalsHeader);

        hospitalsData.forEach((place) => {
          const marker = L.marker([place.lat, place.lng]).addTo(map)
            .bindPopup(`<strong>üè• ${place.name}</strong><br>${place.distance.toFixed(1)} km away`);
          hospitalMarkers.push(marker);

          const item = document.createElement('div');
          item.className = 'hospital-item';
          item.innerHTML = `
            <h4>üè• ${place.name}</h4>
            <p class="distance">üìç ${place.distance.toFixed(1)} km away</p>
          `;
          item.onclick = () => {
            showRoute(place.lat, place.lng);
            marker.openPopup();
          };
          listEl.appendChild(item);
        });
      }
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('collapsed');
    }

    function showRoute(destLat, destLng) {
      if (routeLine) map.removeLayer(routeLine);
      if (!userLat || !userLng) return;
      
      const url = `https://router.project-osrm.org/route/v1/driving/${userLng},${userLat};${destLng},${destLat}?overview=full&geometries=geojson`;

      fetch(url).then(r => r.json()).then(data => {
        if (data.routes && data.routes.length > 0) {
          const coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
          routeLine = L.polyline(coords, { color: '#00cc44', weight: 5, opacity: 0.8 }).addTo(map);
          map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
        }
      }).catch(() => {
        routeLine = L.polyline([[userLat, userLng], [destLat, destLng]], {
          color: '#00cc44', weight: 4, opacity: 0.7, dashArray: '10, 10'
        }).addTo(map);
        map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
      });
    }

    function showRequestDetails(requestId) {
      const request = bloodRequests.find(r => r.id === requestId);
      if (!request) return;

      document.getElementById('modal-blood-group').textContent = request.bloodGroup;
      
      const urgencyText = request.urgency === 'high' ? 'üî¥ High - Need within hours' : 
                          request.urgency === 'medium' ? 'üü° Medium - Need within 24 hours' : 
                          'üü¢ Low - Need within a week';

      document.getElementById('modal-details').innerHTML = `
        <div class="detail-row"><span class="label">Patient Name</span><span class="value">${request.patientName}</span></div>
        <div class="detail-row"><span class="label">Hospital</span><span class="value">${request.hospitalName}</span></div>
        <div class="detail-row"><span class="label">Units Required</span><span class="value">${request.unitsRequired}</span></div>
        <div class="detail-row"><span class="label">Urgency</span><span class="value">${urgencyText}</span></div>
        <div class="detail-row"><span class="label">Required By</span><span class="value">${formatDate(request.requiredBy)}</span></div>
        <div class="detail-row"><span class="label">Contact</span><span class="value">${request.contactNumber}</span></div>
        ${request.notes ? `<div class="detail-row"><span class="label">Notes</span><span class="value">${request.notes}</span></div>` : ''}
        <div class="detail-row"><span class="label">Posted</span><span class="value">${formatDate(request.createdAt)}</span></div>
      `;

      document.getElementById('contact-btn').href = `tel:${request.contactNumber}`;
      document.getElementById('modal-overlay').classList.add('active');

      // Show route to hospital
      if (request.hospitalLat && request.hospitalLng) {
        showRoute(request.hospitalLat, request.hospitalLng);
      }
    }

    function closeModal() {
      document.getElementById('modal-overlay').classList.remove('active');
    }

    document.getElementById('modal-overlay').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });

    function searchNearbyHospitals() {
      if (userLat && userLng) {
        window.open(`https://www.google.com/maps/search/blood+bank+hospital/@${userLat},${userLng},14z`, '_blank');
      }
    }

    initMap();
  </script>
</body>
</html>
